<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>MCP Studio – GitLab + LLM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">MCP Studio</div>

    <div class="project-chip" id="active-project">Kein Projekt gewählt</div>

    <div class="model-select">
      <label for="provider">Provider:</label>
      <select id="provider">
        <option value="gemini" selected>gemini</option>
        <option value="openai">openai</option>
        <option value="ollama">ollama (lokal)</option>
      </select>

      <label for="model">Model:</label>
      <select id="model">
        <option value="gemini-2.0-flash" selected>gemini-2.0-flash</option>
        <option value="gpt-4o-mini">gpt-4o-mini</option>
        <option value="deepseek-r1:7b">deepseek-r1:7b (ollama)</option>
      </select>

      <button id="btn-pull-model" title="Lokales Modell laden">Pull</button>
    </div>

    <button id="btn-reset" title="Konversation & Kontext zurücksetzen">Reset</button>

    <div class="agent-controls">
      <button id="btn-agent-start">Agent starten</button>
      <span id="agent-status-chip" class="chip muted">Idle</span>
    </div>
  </header>

  <div class="layout">
    <!-- LEFT -->
    <aside class="left">
      <input id="proj-search" placeholder="Projekte suchen…" />

      <nav class="tabs">
        <button class="tab-btn active" data-tab="projects">Projects</button>
        <button class="tab-btn" data-tab="issues">Issues</button>
        <button class="tab-btn" data-tab="mrs">MRs</button>
        <button class="tab-btn" data-tab="pipelines">Pipelines</button>
      </nav>

      <div class="tab-content">
        <div id="tab-projects" class="tab-pane active">
          <ul id="projects-list" class="list"></ul>
        </div>
        <div id="tab-issues" class="tab-pane">
          <div id="issues-empty" class="muted small">Keine Issues geladen</div>
          <ul id="issues-list" class="list"></ul>
        </div>
        <div id="tab-mrs" class="tab-pane">
          <div id="mrs-empty" class="muted small">Keine Merge Requests geladen</div>
          <ul id="mrs-list" class="list"></ul>
        </div>
        <div id="tab-pipelines" class="tab-pane">
          <div id="pipes-empty" class="muted small">Keine Pipelines geladen</div>
          <ul id="pipes-list" class="list"></ul>
        </div>
      </div>
    </aside>

    <!-- CENTER -->
    <main class="center">
      <div id="messages" class="chat"></div>

      <form id="composer">
        <textarea id="input" placeholder="Schreibe eine Nachricht … (Shift+Enter = Zeilenumbruch)"></textarea>
        <button type="submit">Senden</button>
      </form>

      <section id="code-view" class="code-view hidden">
        <header>
          <span id="code-path"></span>
          <button id="code-close">×</button>
        </header>
        <pre id="code-content"></pre>
      </section>
    </main>

    <!-- RIGHT -->
    <aside class="right">
      <section id="proj-meta" class="panel">
        <h3>Projekt</h3>
        <div id="proj-meta-content" class="muted small">–</div>
      </section>

      <section id="readme" class="panel">
        <h3>README</h3>
        <pre id="readme-content" class="pre-scroll muted">–</pre>
      </section>

      <section id="tree" class="panel">
        <h3>Repo Tree</h3>
        <ul id="tree-list" class="tree"></ul>
      </section>

      <section id="agent-panel" class="panel">
        <h3>Coding-Agent</h3>
        <div id="agent-info" class="muted small">Noch nicht gestartet.</div>
      </section>

      <details>
        <summary>Trace / Debug</summary>
        <button id="btn-show-conv" class="small">Conv</button>
        <button id="btn-show-context" class="small">Context</button>
        <pre id="trace-content" class="pre-scroll small"></pre>
      </details>
    </aside>
  </div>

  <script type="module">
    // ====== Utility ======
    const sid = Math.random().toString(36).slice(2);
    let activeProject = null;
    let modelSelect = null;
    let providerSelect = null;
    let pollingAgent = false;

    async function api(path, body, method = "POST") {
      const opt = { method, headers: { "Content-Type": "application/json" } };
      if (body) opt.body = JSON.stringify(body);
      const r = await fetch(path, opt);
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }
    const GET = async (p) => {
      const r = await fetch(p);
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    };

    function el(q){ return document.querySelector(q); }
    function els(q){ return Array.from(document.querySelectorAll(q)); }

    function escapeHTML(s){
      if (s == null) return "";
      return String(s).replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    }

    function normalizeProject(p){
      if(!p || typeof p !== 'object') return {};
      return {
        id:             p.id ?? p.project_id ?? p.result?.id,
        name:           p.name ?? p.name_with_namespace ?? p.path ?? p.path_with_namespace ?? "Unbekannt",
        path:           p.path ?? p.path_with_namespace ?? "",
        web_url:        p.web_url ?? "",
        default_branch: p.default_branch ?? "main",
        readme:         p.readme ?? "",
        root_tree:      Array.isArray(p.root_tree) ? p.root_tree : []
      };
    }

    function addMessage(role, text){
      const box = el('#messages');
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + role;
      wrap.innerHTML = `<div class="bubble">${escapeHTML(text)}</div>`;
      box.appendChild(wrap);
      box.scrollTop = box.scrollHeight;
    }

    function renderProjectMeta(desc){
      const path = desc.path || "-";
      const t = `
ID: ${escapeHTML(desc.id)}<br>
Pfad: ${escapeHTML(path)}<br>
URL: <a href="${escapeHTML(desc.web_url)}" target="_blank">${escapeHTML(desc.web_url)}</a><br>
Branch: ${escapeHTML(desc.default_branch)}
`;
      el('#proj-meta-content').innerHTML = t;
    }

    function renderREADME(txt){ el('#readme-content').textContent = txt || '–'; }

    function renderTree(tree){
      const ul = el('#tree-list');
      ul.innerHTML = '';
      if(!tree || !tree.length){
        ul.innerHTML = '<li class="muted small">leer</li>';
        return;
      }
      tree.forEach(it=>{
        const li = document.createElement('li');
        li.className = it.type;
        li.textContent = it.path;
        li.addEventListener('click', async (e)=>{
          e.stopPropagation();
          if(it.type === 'blob'){
            const file = await api(`/api/tool/get_file`, {arguments:{
              project_ref: activeProject.id,
              file_path: it.path,
              ref: activeProject.default_branch,
              decode: true
            }});
            const c = (file.result && (file.result.content || file.result.content_base64)) || "";
            showCode(it.path, c);
          }
        });
        ul.appendChild(li);
      });
    }

    function showCode(path, content){
      el('#code-path').textContent = path;
      el('#code-content').textContent = content;
      el('#code-view').classList.remove('hidden');
    }
    el('#code-close').onclick = ()=> el('#code-view').classList.add('hidden');

    function switchTab(name){
      els('.tab-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
      els('.tab-pane').forEach(p=>p.classList.toggle('active', p.id==='tab-'+name));
    }

    function renderProjects(list){
      const ul = el('#projects-list');
      ul.innerHTML='';
      (list||[]).forEach(p=>{
        const li = document.createElement('li');
        li.textContent = `${p.name} (ID: ${p.id})`;
        li.className='clickable';
        li.onclick = ()=> selectProject(p.id);
        ul.appendChild(li);
      });
    }

    async function selectProject(ref){
      try{
        const res = await api('/api/select_project', { project_ref: String(ref), session_id: sid });
        activeProject = normalizeProject(res.project);
        el('#active-project').textContent = `${activeProject.name} (ID ${activeProject.id})`;
        renderProjectMeta(activeProject);
        renderREADME(activeProject.readme);
        renderTree(activeProject.root_tree);
        addMessage('llm', `Projekt ${activeProject.id} (${activeProject.name}) ist jetzt aktiv. Was möchtest du wissen?`);
      }catch(e){
        console.error(e);
        addMessage('llm', 'Fehler beim Setzen des Projekts: ' + e.message);
      }
    }

    async function loadProjects(){
      const res = await GET('/api/projects');
      renderProjects(res.projects);
    }

    // -------- Chat ----------
    async function sendChat(text){
      addMessage('user', text);
      const model    = modelSelect.value;
      const provider = providerSelect.value;
      try{
        const res = await api('/api/chat', {
          message: text,
          session_id: sid,
          model,
          provider,
          max_steps: 8
        });
        addMessage('llm', res.answer ?? JSON.stringify(res.error));
      }catch(e){
        addMessage('llm', 'Error: ' + e.message);
      }
    }

    // -------- Local LLM ----------
    async function pullLocalModel(){
      const m = modelSelect.value;
      if(!m.includes(':')) { alert('Bitte ein Ollama-Modell auswählen (z.B. deepseek-r1:7b)'); return; }
      try{
        addMessage('llm', `Pull "${m}"...`);
        const res = await api(`/api/local_llm/pull?model=${encodeURIComponent(m)}`, null, "POST");
        addMessage('llm', `Pulled: ${m}`);
      }catch(e){
        addMessage('llm', 'Pull-Fehler: ' + e.message);
      }
    }

    // -------- Debug ----------
    async function showConv(){
      const res = await GET(`/api/debug/conv?sid=${sid}`);
      el('#trace-content').textContent = JSON.stringify(res, null, 2);
    }
    async function showContext(){
      const res = await GET(`/api/debug/context?sid=${sid}`);
      el('#trace-content').textContent = JSON.stringify(res, null, 2);
    }

    // -------- Coding Agent ----------
    async function startAgent(){
      if(!activeProject){ alert("Wähle zuerst ein Projekt."); return; }
      const ns = prompt("Fork Namespace (leer = eigener Account):", "");
      await api('/api/coding/start', {
        session_id: sid,
        source_project: activeProject.id,
        fork_namespace: ns || null
      });
      el('#agent-status-chip').textContent = "Running";
      el('#agent-status-chip').classList.remove('muted');
      el('#agent-info').textContent = "Agent gestartet…";
      if(!pollingAgent) pollAgent();
    }

    async function pollAgent(){
      pollingAgent = true;
      while(true){
        try{
          const s = await GET(`/api/coding/status?sid=${sid}`);
          if(s && s.state){
            el('#agent-info').textContent = JSON.stringify(s, null, 2);
            el('#agent-status-chip').textContent = s.state;
            if(s.state === 'done' || s.state === 'error') break;
          }
        }catch(e){ console.warn("agent status error", e); break; }
        await new Promise(r=>setTimeout(r, 3000));
      }
      pollingAgent = false;
      el('#agent-status-chip').classList.add('muted');
    }

    // -------- Events ----------
    modelSelect    = el('#model');
    providerSelect = el('#provider');
    el('#btn-pull-model').onclick = pullLocalModel;

    el('#btn-reset').onclick = async ()=>{
      await api('/api/chat', {message:"",session_id:sid,reset:true}, "POST");
      el('#messages').innerHTML='';
      el('#trace-content').textContent='';
      addMessage('llm', 'Reset OK');
    };

    el('#btn-agent-start').onclick = startAgent;
    el('#btn-show-conv').onclick   = showConv;
    el('#btn-show-context').onclick= showContext;

    els('.tab-btn').forEach(btn=>btn.onclick = ()=>switchTab(btn.dataset.tab));
    el('#proj-search').oninput = (e)=>{
      const val = e.target.value.toLowerCase();
      els('#projects-list li').forEach(li=>{
        li.style.display = li.textContent.toLowerCase().includes(val) ? '' : 'none';
      });
    };

    el('#composer').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const txt = el('#input').value.trim();
      if(!txt) return;
      el('#input').value = '';
      await sendChat(txt);
    });
    el('#input').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        el('#composer').dispatchEvent(new Event('submit'));
      }
    });

    // Init
    addMessage('llm', 'Willkommen! Wähle links ein Projekt oder stelle eine Frage.');
    loadProjects();
  </script>
</body>
</html>
